# hive-player-service
Hive Player Service.
All transactions from hive games go via hive-player, including real money transactions destined for the operator wallet, demo play transactions destined for hive-demo-wallet and free round transactions destined for hive-bonus-wallet.  

## Postgres Database

hive-player-service uses a postgres database.  
 
The database name is governed by `spring.datasource.url` as per usual with our JPA based applications.

The database schema for the hive-player database is available in [src/main/resources/db/player/schema-postgres.sql](src/main/resources/db/player/schema-postgres.sql).  Scripts are also available in [src/main/resources/db/player/](src/main/resources/db/player/) to drop the database data and schema.

## Configuration
| Config Item                                           | Description                                                                                                                                                                                                                                                                                                                                                                             | Required            | Example                                                  | Default                        |
|-------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------|----------------------------------------------------------|--------------------------------|
| spring.profile.active                                 | name of the active profile. when this property is set to 'test' the gameId cache populator will not be initialised                                                                                                                                                                                                                                                                      | yes                 | default                                                  | n/a                            |
| spring.datasource.url                                 | jdbc url for the hive-player db                                                                                                                                                                                                                                                                                                                                                         | yes                 | jdbc:postgresql://127.0.0.1:5432/hive_player             | n/a                            |
| spring.datasource.password                            | password for the hive-player db                                                                                                                                                                                                                                                                                                                                                         | yes                 | password                                                 | n/a                            |
| spring.datasource.username                            | username for the hive-player db                                                                                                                                                                                                                                                                                                                                                         | yes                 | gsi                                                      | n/a                            |
| server.tomcat.max-threads                             | number of http threads                                                                                                                                                                                                                                                                                                                                                                  | no                  | 100                                                      | 100                            |
| hive.session.expirySecs                               | expiry time for hive sessions in seconds                                                                                                                                                                                                                                                                                                                                                | no                  | 300                                                      | 300                            |
| hive.recon.enabled                                    | turns reconciliation tasks on/off                                                                                                                                                                                                                                                                                                                                                       | no                  | true                                                     | false                          | true |
| hive.recon.maxRetries                                 | number of times that hive-player will attempt auto reconciliation before putting the txn in a manual recon state                                                                                                                                                                                                                                                                        | no                  | 60                                                       | 10                             |
| hive.recon.txn.offsetSeconds                          | the delay (s) after the initial transaction attempt that it will be considered for reconciliation                                                                                                                                                                                                                                                                                       | no                  |                                                          | 30                             |
| hive.recon.txn.batchPause                             | the delay (s) between individual batch pauses                                                                                                                                                                                                                                                                                                                                           | no                  |                                                          | 30                             |
| hive.recon.scheduler.initialDelay                     | the delay (ms) after startup before starting automatic reconciliation                                                                                                                                                                                                                                                                                                                   | no                  |                                                          | 60000                          |
| hive.recon.scheduler.fixedDelay                       | the delay (ms) between each batch of automatic reconciliation                                                                                                                                                                                                                                                                                                                           | no                  |                                                          | 30000                          |
| hive.recon.gamepoll.initialDelay                      | the delay (ms) after startup before starting game polling for missing transactions                                                                                                                                                                                                                                                                                                      | no                  |                                                          | 90000                          |
| hive.recon.gamepoll.fixedDelay                        | the delay (ms) after startup between game polling for missing transactions                                                                                                                                                                                                                                                                                                              | no                  |                                                          | 120000                         |
| hive.recon.callbackRetries                            | the maximum number of times to retry a game callback after transaction reconciliation                                                                                                                                                                                                                                                                                                   | no                  |                                                          | 4                              |
| hive.recon.callbackBatchSize                          | the batch size for transaction callbacks                                                                                                                                                                                                                                                                                                                                                | no                  |                                                          | 30                             |
| hive.recon.callbackBatchPause                         | the pause between batches                                                                                                                                                                                                                                                                                                                                                               | no                  |                                                          | 10                             |
| hive.recon.callback.initialDelay                      | the delay (ms) after startup before sending transaction callbacks                                                                                                                                                                                                                                                                                                                       | no                  |                                                          | 30000                          |
| hive.recon.callback.fixedDelay                        | the delay (ms) between each batch of transaction callbacks                                                                                                                                                                                                                                                                                                                              | no                  |                                                          | 30000                          |
| hive.recon.http.readTimeout                           | the timeout in milliseconds for http connections used in reconciliation                                                                                                                                                                                                                                                                                                                 | no                  |                                                          | 3000                           |
| hive.recon.http.connectTimeout                        | the timeout in milliseconds for http connections used in reconciliation                                                                                                                                                                                                                                                                                                                 | no                  |                                                          | 1000                           |
| hive.recon.http.maxConnections                        | the maximum number of simultaneous connections used in reconciliation                                                                                                                                                                                                                                                                                                                   | no                  |                                                          | 100                            |
| hive.player.apiKey.enabled                            | whether apiKey security is enabled on the S2S endpoints                                                                                                                                                                                                                                                                                                                                 | no                  | true                                                     | true                           |
| hive.player.apiKey                                    | apiKey for S2S endpoints (header is called Hive-Player-API-Key)                                                                                                                                                                                                                                                                                                                         | yes                 | blah                                                     | n/a                            |
| endpoint.bonusWallet.http.maxConnections              | number of http connections to the bonus wallet                                                                                                                                                                                                                                                                                                                                          | no                  | 100                                                      | 100                            |
| endpoint.demoWallet.http.maxConnections               | number of http connections to the demo wallet                                                                                                                                                                                                                                                                                                                                           | no                  | 100                                                      | 100                            |
| endpoint.mesh.http.maxConnections                     | number of http connections to mesh-rgs-hive                                                                                                                                                                                                                                                                                                                                             | no                  | 100                                                      | 100                            |
| endpoint.registry.serviceName                         | the service name to use when connecting to hive-registry                                                                                                                                                                                                                                                                                                                                | no                  | hive-registry-service-v1:9004                            | hive-registry-service-v1:9004  |
| endpoint.registry.apiKey                              | apiKey for hive-registry endpoints (header is called RegistryService-API-Key)                                                                                                                                                                                                                                                                                                           | yes                 | exampleApiKey                                            | n/a                            |
| endpoint.registry.http.readTimeout                    | the read timeout in milliseconds for http connections to hive-registry                                                                                                                                                                                                                                                                                                                  | no                  | 3000                                                     | 3000                           |
| endpoint.registry.http.connectTimeout                 | the connection timeout in milliseconds for http connections to hive-registry                                                                                                                                                                                                                                                                                                            | no                  | 1000                                                     | 1000                           |
| endpoint.registry.http.maxConnections                 | the maximum number of simultaneous connections                                                                                                                                                                                                                                                                                                                                          | no                  | 10                                                       | 10                             |
| endpoint.registry.igpCodes.cache.expirySeconds        | the IGP codes cache lifetime duration for calls to hive-registry, in seconds                                                                                                                                                                                                                                                                                                            | no                  | 1800                                                     | 1800                           |
| endpoint.registry.gameId.cache.expirySeconds          | the game id cache lifetime duration for calls to hive-registry, in seconds                                                                                                                                                                                                                                                                                                              | no                  | 1800                                                     | 1800                           |
| endpoint.registry.gameId.cache.autoRepopulate.enabled | whether the game id cache should automatically repopulate. if set to true, every (endpoint.registry.gameId.cache.expirySeconds / 2), a call will be made to registry with the same parameters as used initially. If the response to this call is valid, the cache will be repopulated with the response, else it will be repopulated with the value already in cache                    | no                  | true                                                     | true                           |
| hive.game.id.validation.level                         | the validation level to use when checking game ids from sessions against txn game ids, one of (NONE, PERMISSIVE or STRICT). If set to STRICT, any validation failure will publish a Prometheus metric and throw an exception. If set to permissive, any validation failure will publish a Prometheus metric but not throw an exception. If set to NONE, no validation will be performed | no                  | STRICT                                                   | PERMISSIVE                     |
| endpoints.prometheus.enabled                          | whether the prometheus endpoint is enabled                                                                                                                                                                                                                                                                                                                                              | no                  | true                                                     | false                          |
| hive.bonusWalletApiKey                                | API key for communication to bonus wallet                                                                                                                                                                                                                                                                                                                                               | yes                 | blah                                                     | n/a                            |
| hive.demoWalletApiKey                                 | API key for communication to demo wallet                                                                                                                                                                                                                                                                                                                                                | yes                 | blah                                                     | n/a                            |
| hive.mesh.meshApiKey                                  | API key for communication to mesh-rgs-hive                                                                                                                                                                                                                                                                                                                                              | yes                 | blah                                                     | n/a                            |
| hive.mesh.meshBaseUrl                                 | Base URL for communication to mesh-rgs-hive                                                                                                                                                                                                                                                                                                                                             | yes                 | http://mesh-node-rgs-hive.default.svc.cluster.local:8019 | n/a                            |
| hive.autocomplete.enabled                             | whether autocompletion is enabled                                                                                                                                                                                                                                                                                                                                                       | yes                 | true                                                     | n/a                            |
| hive.autocomplete.scheduler.request.initialDelay      | the delay (ms) from startup before starting to send any available autocomplete requests                                                                                                                                                                                                                                                                                                 | no                  |                                                          | 60000                          |
| hive.autocomplete.scheduler.request.fixedDelay        | the delay (ms) between each batch of autocompletion requests                                                                                                                                                                                                                                                                                                                            | no                  |                                                          | 120000                         |
| hive.autocomplete.scheduler.queue.initialDelay        | the delay (ms) from startup before starting to look for gameplays to autocomplete                                                                                                                                                                                                                                                                                                       | no                  |                                                          | 60000                          |
| hive.autocomplete.scheduler.queue.fixedDelay          | the delay (ms) between each query looking for gameplays to autocomplete                                                                                                                                                                                                                                                                                                                 | no                  |                                                          | 1200000                        |
| hive.autocomplete.http.readTimeout                    | the timeout in milliseconds for http reads of autocomplete endpoints on games                                                                                                                                                                                                                                                                                                           | no                  | 6000                                                     | 3000                           |
| hive.autocomplete.http.connectTimeout                 | the timeout in milliseconds for http connections to autocomplete endpoints on games                                                                                                                                                                                                                                                                                                     | no                  | 2000                                                     | 1000                           |
| hive.autocomplete.http.maxConnections                 | the maximum number of simultaneous connections to make to autocomplete endpoints on games                                                                                                                                                                                                                                                                                               | no                  | 200                                                      | 100                            |
| hive.autocomplete.autocompleteRetries                 | the number of times that autocompletion will be attempted for a play                                                                                                                                                                                                                                                                                                                    | no                  | 10                                                       | 5                              |
| hive.autocomplete.autocompleteBatchSize               | the number of autocompletion requests that will be performed in each batch                                                                                                                                                                                                                                                                                                              | no                  | 60                                                       | 30                             |
| hive.autocomplete.request.batchPause                  | the number of seconds to wait between processing autocomplete batches                                                                                                                                                                                                                                                                                                                   | no                  | 20                                                       | 10                             |
| hive.autocomplete.requestRetries                      | the maximum number of times that hitting the autocomplete endpoint on a game will be retried                                                                                                                                                                                                                                                                                            | no                  | 8                                                        | 4                              |
| hive.autocomplete.completionDeadlineMinutes           | map of igp to number of minutes to wait before plays should be autocompleted                                                                                                                                                                                                                                                                                                            | yes                 | {iguana:60}                                              | n/a                            |
| hive.autocomplete.endpointLoadBalanced.enabled        | whether to use load balancing on the autocompletion endpoint                                                                                                                                                                                                                                                                                                                            | no                  | false                                                    | true                           |
| hive.player.login.preferLegacyAuth                    | if a playerId is present on auth, switch between using legacy auth with playerId as path param, or new auth with playerId as requestParam                                                                                                                                                                                                                                               | no                  | false                                                    | true                           |
| hive.reports.sql.maxConnPoolSize                      | maximum number of jdbc connection in reporting pool                                                                                                                                                                                                                                                                                                                                     | no                  | 1                                                        | 1                              |
| hive.reports.sql.statementTimeoutSeconds              | number of seconds for reports SQL query to timeout                                                                                                                                                                                                                                                                                                                                      | no                  | 20                                                       | 20                             |
| hive.guestauth.igpcodes                               | A comma separated list of igp codes to enable guest validation for                                                                                                                                                                                                                                                                                                                      | no                  | iguana,gecko                                             | n/a                            |
| hive.player.backOffice.apiKey.enabled                 | Whether requests from Back Office should be checked for an API key.                                                                                                                                                                                                                                                                                                                     | no                  | true                                                     | false                          |
| hive.player.backOffice.apiKey                         | Expected API key for communications from Back Office.                                                                                                                                                                                                                                                                                                                                   | no, unless enabled. | %5yx!&Mb                                                 | N/A                            |
| hive.recon.monitoring.enabled                         | Whether the recon monitoring enabled.                                                                                                                                                                                                                                                                                                                                                   | yes                 | false                                                    | false                          |
| hive.recon.monitoring.scheduleMillis                  | The delay in milliseconds for the job run.                                                                                                                                                                                                                                                                                                                                              | no                  | 3600000                                                  | 3600000 which is once an hour  |
| hive.recon.monitoring.txnAlertAgeMins                 | The age of a transaction, in minutes, before it's eligible to be counted by the recon/pending monitoring scheduled service.                                                                                                                                                                                                                                                             | no                  | 60                                                       | 60 which is an hour            |

## Platform Configuration

A config record similar to the following should be added to hive-registry to enable game id verification:

type: ```GAME_ID```

config tags:
```json
{"configType":["validGameIds"]}
```
config:
```json
{"gameCodeToGameId": {"bigbamboo-01":11038,"bigbamboo-02":11039,...}}
```

## Grafana Setup Instructions
Add the following to the prometheus configmap

```
- job_name: 'hive-player'
  metrics_path: '/hive/sys/prometheus'
  static_configs:
  - targets: ['hive-player-service.default.svc.cluster.local:9001']
```
Import the dashboard from ./grafana/exceptions-for-game-validation-service-dashboard.json by going to /grafana/dashboard/import (e.g. https://monitoring.integration.gsi.io/grafana/dashboard/import) and clicking "Upload .json file"

Set up notifications for the "Game validation exceptions (past 24h)" panel by following the instructions at https://grafana.com/docs/grafana/latest/alerting/notifications/

## Service Dependencies

| Service | Version|
| ------- | ------- |
| hive-demo-wallet-service-v1 | ^1.0.0 |
| hive-bonus-wallet-service-v1 | ^1.2.0 |
| mesh-node-rgs-hive | ^1.4.1 |
| hive-registry-service | ^1.19.0 |

## Endpoints

| Endpoint | URL Path |
| -------- | -------- |
| Prometheus | /hive/sys/prometheus |
| Health | /hive/sys/health |
| S2S API | /hive/s2s/platform/player/v1 |
| Back Office API | /hive/bo/platform/player/v1 |
